<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pickleball Line Review</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1::before {
            content: "üèì";
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #888;
        }

        .recording-indicator.active {
            color: #ff4757;
        }

        .recording-indicator.active::before {
            content: "";
            width: 10px;
            height: 10px;
            background: #ff4757;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .video-container {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #liveVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #reviewCanvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .overlay-info {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-badge {
            background: rgba(0, 0, 0, 0.75);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            backdrop-filter: blur(4px);
        }

        .info-badge.recording {
            color: #00ff88;
        }

        .info-badge.review {
            color: #ffa502;
        }

        .speed-indicator {
            background: #ff6b6b;
            color: white;
            font-weight: 600;
        }

        .time-badge {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.75);
            padding: 8px 14px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 16px;
            backdrop-filter: blur(4px);
        }

        .buffer-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.75);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            backdrop-filter: blur(4px);
        }

        .buffer-badge span {
            color: #00ff88;
            font-weight: 600;
        }

        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .status-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #333;
            border-top-color: #ffa502;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-text {
            font-size: 16px;
            color: #ccc;
        }

        .error-box {
            background: rgba(255, 71, 87, 0.15);
            border: 1px solid #ff4757;
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            max-width: 320px;
            text-align: center;
        }

        .error-box h3 {
            color: #ff4757;
            margin-bottom: 12px;
        }

        .error-box p {
            font-size: 14px;
            color: #aaa;
            line-height: 1.5;
        }

        .controls {
            background: linear-gradient(180deg, #16213e 0%, #0f0f1a 100%);
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .mode-label {
            text-align: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .mode-label.live {
            color: #00ff88;
        }

        .mode-label.review {
            color: #ffa502;
        }

        .camera-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 10px;
            background: #1a1a2e;
            color: white;
            font-size: 14px;
            margin-bottom: 12px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .primary-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.15s, opacity 0.15s;
        }

        .primary-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        .review-btn {
            background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
            color: white;
        }

        .back-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00b894 100%);
            color: #000;
        }

        .live-controls {
            display: block;
        }

        .review-controls {
            display: none;
        }

        .review-controls.active {
            display: block;
        }

        .live-controls.hidden {
            display: none;
        }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .ctrl-btn {
            padding: 14px 8px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: transform 0.1s;
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .ctrl-btn .icon {
            font-size: 22px;
        }

        .ctrl-btn.rewind {
            background: #2d3436;
            color: white;
        }

        .ctrl-btn.play {
            background: #00b894;
            color: white;
        }

        .ctrl-btn.play.paused {
            background: #fdcb6e;
            color: #000;
        }

        .ctrl-btn.forward {
            background: #2d3436;
            color: white;
        }

        .speed-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .speed-btn {
            flex: 1;
            padding: 12px 6px;
            border: 2px solid #333;
            border-radius: 10px;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .speed-btn.active {
            border-color: #ffa502;
            background: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }

        .speed-btn:active {
            transform: scale(0.95);
        }

        .frame-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .frame-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 10px;
            background: #1a1a2e;
            color: #aaa;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .frame-btn:active {
            background: #252540;
        }

        .progress-wrap {
            margin-bottom: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffa502, #ff6348);
            width: 0%;
            border-radius: 4px;
            transition: width 0.05s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 6px;
            font-family: 'SF Mono', Monaco, monospace;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Line Review</h1>
            <div class="recording-indicator" id="recordingIndicator">Ready</div>
        </header>

        <div class="video-container">
            <video id="liveVideo" autoplay playsinline muted></video>
            <canvas id="reviewCanvas"></canvas>

            <div class="overlay-info" id="overlayInfo">
                <div class="info-badge recording" id="modeBadge">‚óè LIVE</div>
            </div>

            <div class="buffer-badge" id="bufferBadge">
                Buffer: <span id="bufferCount">0</span>s
            </div>

            <div class="time-badge" id="timeBadge">00:00.0</div>

            <div class="status-overlay" id="statusOverlay">
                <div class="spinner"></div>
                <div class="status-text" id="statusText">Initializing camera...</div>
            </div>
        </div>

        <div class="controls">
            <div class="mode-label live" id="modeLabel">‚óè RECORDING</div>

            <select class="camera-select" id="cameraSelect">
                <option value="">Loading cameras...</option>
            </select>

            <div class="live-controls" id="liveControls">
                <button class="primary-btn review-btn" id="reviewBtn">
                    ‚è™ Review Last Ball
                </button>
            </div>

            <div class="review-controls" id="reviewControls">
                <div class="control-grid">
                    <button class="ctrl-btn rewind" id="rewindBtn">
                        <span class="icon">‚è™</span>
                        <span>‚àí15s</span>
                    </button>
                    <button class="ctrl-btn play" id="playBtn">
                        <span class="icon">‚ñ∂Ô∏è</span>
                        <span>Play</span>
                    </button>
                    <button class="ctrl-btn forward" id="forwardBtn">
                        <span class="icon">‚è©</span>
                        <span>+15s</span>
                    </button>
                </div>

                <div class="speed-row">
                    <button class="speed-btn" data-speed="0.1">0.1√ó</button>
                    <button class="speed-btn" data-speed="0.25">0.25√ó</button>
                    <button class="speed-btn" data-speed="0.5">0.5√ó</button>
                    <button class="speed-btn active" data-speed="1">1√ó</button>
                </div>

                <div class="frame-row">
                    <button class="frame-btn" id="framePrev">‚óÄ Prev Frame</button>
                    <button class="frame-btn" id="frameNext">Next Frame ‚ñ∂</button>
                </div>

                <div class="progress-wrap">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">00:00.0</span>
                        <span id="totalTime">00:00.0</span>
                    </div>
                </div>

                <button class="primary-btn back-btn" id="backBtn">
                    üìπ Back to Live
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FRAME BUFFER APPROACH
        // Store frames as ImageData for reliable playback
        // ============================================

        const CONFIG = {
            FPS: 30,
            BUFFER_SECONDS: 90,
            CAPTURE_WIDTH: 1280,
            CAPTURE_HEIGHT: 720
        };

        const state = {
            mode: 'live',
            stream: null,
            captureCanvas: null,
            captureCtx: null,
            frameBuffer: [],
            maxFrames: CONFIG.FPS * CONFIG.BUFFER_SECONDS,
            isCapturing: false,
            captureInterval: null,

            // Review state
            reviewIndex: 0,
            isPlaying: false,
            playbackSpeed: 1,
            playbackInterval: null
        };

        const el = {
            liveVideo: document.getElementById('liveVideo'),
            reviewCanvas: document.getElementById('reviewCanvas'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            modeBadge: document.getElementById('modeBadge'),
            modeLabel: document.getElementById('modeLabel'),
            bufferBadge: document.getElementById('bufferBadge'),
            bufferCount: document.getElementById('bufferCount'),
            timeBadge: document.getElementById('timeBadge'),
            statusOverlay: document.getElementById('statusOverlay'),
            statusText: document.getElementById('statusText'),
            cameraSelect: document.getElementById('cameraSelect'),
            liveControls: document.getElementById('liveControls'),
            reviewControls: document.getElementById('reviewControls'),
            reviewBtn: document.getElementById('reviewBtn'),
            backBtn: document.getElementById('backBtn'),
            rewindBtn: document.getElementById('rewindBtn'),
            playBtn: document.getElementById('playBtn'),
            forwardBtn: document.getElementById('forwardBtn'),
            framePrev: document.getElementById('framePrev'),
            frameNext: document.getElementById('frameNext'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime')
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            if (!window.isSecureContext) {
                showError('Requires HTTPS', 'Camera access needs a secure connection. Please access via HTTPS.');
                return;
            }

            // Setup capture canvas (offscreen)
            state.captureCanvas = document.createElement('canvas');
            state.captureCanvas.width = CONFIG.CAPTURE_WIDTH;
            state.captureCanvas.height = CONFIG.CAPTURE_HEIGHT;
            state.captureCtx = state.captureCanvas.getContext('2d', { willReadFrequently: true });

            // Setup review canvas
            el.reviewCanvas.width = CONFIG.CAPTURE_WIDTH;
            el.reviewCanvas.height = CONFIG.CAPTURE_HEIGHT;

            try {
                showStatus('Requesting camera access...');
                await getCameras();
                await startCamera();
                hideStatus();
                setupListeners();
            } catch (err) {
                console.error('Init error:', err);
                showError('Camera Error', 'Could not access camera. Please allow camera permission and reload.');
            }
        }

        async function getCameras() {
            // Request permission first
            await navigator.mediaDevices.getUserMedia({ video: true });
            
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(d => d.kind === 'videoinput');

            el.cameraSelect.innerHTML = '';
            cameras.forEach((cam, i) => {
                const opt = document.createElement('option');
                opt.value = cam.deviceId;
                opt.textContent = cam.label || `Camera ${i + 1}`;
                // Prefer back camera
                if (cam.label.toLowerCase().includes('back') || cam.label.toLowerCase().includes('rear')) {
                    opt.selected = true;
                }
                el.cameraSelect.appendChild(opt);
            });

            if (cameras.length === 0) {
                throw new Error('No cameras found');
            }
        }

        async function startCamera(deviceId) {
            // Stop existing stream
            if (state.stream) {
                state.stream.getTracks().forEach(t => t.stop());
                stopCapturing();
            }

            const constraints = {
                video: {
                    width: { ideal: CONFIG.CAPTURE_WIDTH },
                    height: { ideal: CONFIG.CAPTURE_HEIGHT },
                    frameRate: { ideal: CONFIG.FPS },
                    facingMode: deviceId ? undefined : 'environment'
                },
                audio: false
            };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            }

            state.stream = await navigator.mediaDevices.getUserMedia(constraints);
            el.liveVideo.srcObject = state.stream;

            // Wait for video to be ready
            await new Promise(resolve => {
                el.liveVideo.onloadedmetadata = resolve;
            });

            startCapturing();
        }

        // ============================================
        // FRAME CAPTURE
        // ============================================

        function startCapturing() {
            if (state.isCapturing) return;

            state.isCapturing = true;
            state.frameBuffer = [];

            const intervalMs = 1000 / CONFIG.FPS;

            state.captureInterval = setInterval(() => {
                captureFrame();
            }, intervalMs);

            el.recordingIndicator.classList.add('active');
            el.recordingIndicator.textContent = 'Recording';
        }

        function stopCapturing() {
            if (state.captureInterval) {
                clearInterval(state.captureInterval);
                state.captureInterval = null;
            }
            state.isCapturing = false;
            el.recordingIndicator.classList.remove('active');
            el.recordingIndicator.textContent = 'Paused';
        }

        function captureFrame() {
            if (!state.stream || !el.liveVideo.videoWidth) return;

            // Draw current video frame to capture canvas
            state.captureCtx.drawImage(
                el.liveVideo,
                0, 0,
                CONFIG.CAPTURE_WIDTH,
                CONFIG.CAPTURE_HEIGHT
            );

            // Get image data
            const imageData = state.captureCtx.getImageData(
                0, 0,
                CONFIG.CAPTURE_WIDTH,
                CONFIG.CAPTURE_HEIGHT
            );

            // Add to buffer
            state.frameBuffer.push(imageData);

            // Trim old frames
            while (state.frameBuffer.length > state.maxFrames) {
                state.frameBuffer.shift();
            }

            // Update UI
            updateBufferDisplay();
        }

        function updateBufferDisplay() {
            const frames = state.frameBuffer.length;
            const seconds = (frames / CONFIG.FPS).toFixed(1);
            el.bufferCount.textContent = seconds;
        }

        // ============================================
        // REVIEW MODE
        // ============================================

        function enterReviewMode() {
            if (state.frameBuffer.length < CONFIG.FPS) {
                alert('Not enough footage yet. Wait a few seconds and try again.');
                return;
            }

            // Pause live capture
            stopCapturing();

            // Switch to review mode
            state.mode = 'review';
            
            // Start 15 seconds from end (or at start if less footage)
            const framesBack = Math.min(CONFIG.FPS * 15, state.frameBuffer.length - 1);
            state.reviewIndex = state.frameBuffer.length - framesBack;
            state.isPlaying = false;
            state.playbackSpeed = 1;

            // Update UI
            el.liveVideo.style.display = 'none';
            el.reviewCanvas.style.display = 'block';
            el.liveControls.classList.add('hidden');
            el.reviewControls.classList.add('active');
            el.bufferBadge.style.display = 'none';

            el.modeBadge.textContent = '‚è∏ REVIEW';
            el.modeBadge.classList.remove('recording');
            el.modeBadge.classList.add('review');

            el.modeLabel.textContent = '‚è∏ REVIEW MODE';
            el.modeLabel.classList.remove('live');
            el.modeLabel.classList.add('review');

            // Update total time display
            const totalSec = state.frameBuffer.length / CONFIG.FPS;
            el.totalTime.textContent = formatTime(totalSec);

            // Show current frame
            renderCurrentFrame();
            updatePlayButton();
            updateProgressBar();
            updateSpeedButtons();
        }

        function exitReviewMode() {
            // Stop playback
            stopPlayback();

            // Switch back to live
            state.mode = 'live';

            // Update UI
            el.reviewCanvas.style.display = 'none';
            el.liveVideo.style.display = 'block';
            el.reviewControls.classList.remove('active');
            el.liveControls.classList.remove('hidden');
            el.bufferBadge.style.display = 'block';

            el.modeBadge.textContent = '‚óè LIVE';
            el.modeBadge.classList.add('recording');
            el.modeBadge.classList.remove('review');

            el.modeLabel.textContent = '‚óè RECORDING';
            el.modeLabel.classList.add('live');
            el.modeLabel.classList.remove('review');

            // Resume capture
            startCapturing();
        }

        function renderCurrentFrame() {
            if (state.reviewIndex < 0) state.reviewIndex = 0;
            if (state.reviewIndex >= state.frameBuffer.length) {
                state.reviewIndex = state.frameBuffer.length - 1;
            }

            const frame = state.frameBuffer[state.reviewIndex];
            if (!frame) return;

            const ctx = el.reviewCanvas.getContext('2d');
            ctx.putImageData(frame, 0, 0);

            // Update time display
            const currentSec = state.reviewIndex / CONFIG.FPS;
            el.currentTime.textContent = formatTime(currentSec);
            el.timeBadge.textContent = formatTime(currentSec);

            updateProgressBar();
        }

        // ============================================
        // PLAYBACK CONTROLS
        // ============================================

        function togglePlay() {
            if (state.isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (state.reviewIndex >= state.frameBuffer.length - 1) {
                state.reviewIndex = 0; // Restart from beginning
            }

            state.isPlaying = true;
            updatePlayButton();

            const intervalMs = (1000 / CONFIG.FPS) / state.playbackSpeed;

            state.playbackInterval = setInterval(() => {
                state.reviewIndex++;

                if (state.reviewIndex >= state.frameBuffer.length) {
                    stopPlayback();
                    state.reviewIndex = state.frameBuffer.length - 1;
                } else {
                    renderCurrentFrame();
                }
            }, intervalMs);
        }

        function stopPlayback() {
            state.isPlaying = false;
            if (state.playbackInterval) {
                clearInterval(state.playbackInterval);
                state.playbackInterval = null;
            }
            updatePlayButton();
        }

        function seek(seconds) {
            stopPlayback();
            const frameDelta = Math.round(seconds * CONFIG.FPS);
            state.reviewIndex += frameDelta;
            
            // Clamp to valid range
            state.reviewIndex = Math.max(0, Math.min(state.frameBuffer.length - 1, state.reviewIndex));
            
            renderCurrentFrame();
        }

        function stepFrame(direction) {
            stopPlayback();
            state.reviewIndex += direction;
            state.reviewIndex = Math.max(0, Math.min(state.frameBuffer.length - 1, state.reviewIndex));
            renderCurrentFrame();
        }

        function setSpeed(speed) {
            const wasPlaying = state.isPlaying;
            stopPlayback();
            state.playbackSpeed = speed;
            updateSpeedButtons();
            if (wasPlaying) {
                startPlayback();
            }
        }

        function seekToPosition(e) {
            const rect = el.progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const targetIndex = Math.floor(percent * state.frameBuffer.length);
            
            stopPlayback();
            state.reviewIndex = Math.max(0, Math.min(state.frameBuffer.length - 1, targetIndex));
            renderCurrentFrame();
        }

        // ============================================
        // UI UPDATES
        // ============================================

        function updatePlayButton() {
            if (state.isPlaying) {
                el.playBtn.innerHTML = '<span class="icon">‚è∏</span><span>Pause</span>';
                el.playBtn.classList.remove('paused');
            } else {
                el.playBtn.innerHTML = '<span class="icon">‚ñ∂Ô∏è</span><span>Play</span>';
                el.playBtn.classList.add('paused');
            }
        }

        function updateProgressBar() {
            const percent = (state.reviewIndex / (state.frameBuffer.length - 1)) * 100;
            el.progressFill.style.width = `${percent}%`;
        }

        function updateSpeedButtons() {
            document.querySelectorAll('.speed-btn').forEach(btn => {
                const speed = parseFloat(btn.dataset.speed);
                btn.classList.toggle('active', speed === state.playbackSpeed);
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const tenths = Math.floor((seconds % 1) * 10);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${tenths}`;
        }

        function showStatus(text) {
            el.statusText.textContent = text;
            el.statusOverlay.classList.remove('hidden');
        }

        function hideStatus() {
            el.statusOverlay.classList.add('hidden');
        }

        function showError(title, message) {
            el.statusOverlay.innerHTML = `
                <div class="error-box">
                    <h3>${title}</h3>
                    <p>${message}</p>
                </div>
            `;
            el.statusOverlay.classList.remove('hidden');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        function setupListeners() {
            el.cameraSelect.addEventListener('change', async (e) => {
                if (e.target.value) {
                    showStatus('Switching camera...');
                    try {
                        await startCamera(e.target.value);
                        hideStatus();
                    } catch (err) {
                        showError('Camera Error', 'Could not switch camera.');
                    }
                }
            });

            el.reviewBtn.addEventListener('click', enterReviewMode);
            el.backBtn.addEventListener('click', exitReviewMode);

            el.playBtn.addEventListener('click', togglePlay);
            el.rewindBtn.addEventListener('click', () => seek(-15));
            el.forwardBtn.addEventListener('click', () => seek(15));

            el.framePrev.addEventListener('click', () => stepFrame(-1));
            el.frameNext.addEventListener('click', () => stepFrame(1));

            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setSpeed(parseFloat(btn.dataset.speed));
                });
            });

            el.progressBar.addEventListener('click', seekToPosition);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (state.mode !== 'review') return;

                switch (e.key) {
                    case ' ':
                        e.preventDefault();
                        togglePlay();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        seek(-5);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        seek(5);
                        break;
                    case ',':
                        stepFrame(-1);
                        break;
                    case '.':
                        stepFrame(1);
                        break;
                }
            });
        }

        // Start the app
        init();
    </script>
</body>
</html>
