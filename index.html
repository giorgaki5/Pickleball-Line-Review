<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pickleball Line Review</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* ========== HEADER ========== */
        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header h1::before {
            content: "üèì";
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #888;
        }

        .recording-indicator.active {
            color: #ff4757;
        }

        .recording-indicator.active::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #ff4757;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .fullscreen-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .fullscreen-btn:active {
            background: rgba(255,255,255,0.2);
        }

        /* ========== VIDEO CONTAINER ========== */
        .video-container {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 0;
        }

        #liveVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #reviewCanvas {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: none;
            object-fit: contain;
        }

        .overlay-info {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
        }

        .info-badge {
            background: rgba(0, 0, 0, 0.75);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            backdrop-filter: blur(4px);
        }

        .info-badge.recording { color: #00ff88; }
        .info-badge.review { color: #ffa502; }

        .time-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            padding: 6px 10px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            backdrop-filter: blur(4px);
            z-index: 10;
        }

        .buffer-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            backdrop-filter: blur(4px);
            z-index: 10;
        }

        .buffer-badge span {
            color: #00ff88;
            font-weight: 600;
        }

        /* ========== VIDEO SCRUBBER (Review Mode) ========== */
        .video-scrubber {
            position: absolute;
            bottom: 50px;
            left: 12px;
            right: 12px;
            z-index: 20;
            display: none;
        }

        .video-scrubber.visible {
            display: block;
        }

        .scrubber-track {
            width: 100%;
            height: 40px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .scrubber-input {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #ffa502 0%, #ffa502 var(--progress, 0%), #444 var(--progress, 0%), #444 100%);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .scrubber-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .scrubber-input::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        /* ========== STATUS OVERLAY ========== */
        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .status-overlay.hidden { display: none; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #ffa502;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .status-text {
            font-size: 14px;
            color: #ccc;
        }

        .error-box {
            background: rgba(255, 71, 87, 0.15);
            border: 1px solid #ff4757;
            border-radius: 12px;
            padding: 16px;
            margin: 16px;
            max-width: 300px;
            text-align: center;
        }

        .error-box h3 {
            color: #ff4757;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .error-box p {
            font-size: 13px;
            color: #aaa;
            line-height: 1.4;
        }

        /* ========== CONTROLS ========== */
        .controls {
            background: linear-gradient(180deg, #16213e 0%, #0f0f1a 100%);
            padding: 10px 12px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            flex-shrink: 0;
        }

        .mode-label {
            text-align: center;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .mode-label.live { color: #00ff88; }
        .mode-label.review { color: #ffa502; }

        .camera-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .camera-select {
            flex: 1;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: white;
            font-size: 13px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }

        .primary-btn:active {
            transform: scale(0.97);
        }

        .review-btn {
            background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
            color: white;
        }

        .back-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00b894 100%);
            color: #000;
        }

        .live-controls { display: block; }
        .review-controls { display: none; }
        .review-controls.active { display: block; }
        .live-controls.hidden { display: none; }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ctrl-btn {
            padding: 10px 6px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .ctrl-btn:active { transform: scale(0.95); }
        .ctrl-btn .icon { font-size: 18px; }
        .ctrl-btn.rewind { background: #2d3436; color: white; }
        .ctrl-btn.play { background: #00b894; color: white; }
        .ctrl-btn.play.paused { background: #fdcb6e; color: #000; }
        .ctrl-btn.forward { background: #2d3436; color: white; }

        .speed-row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .speed-btn {
            flex: 1;
            padding: 10px 4px;
            border: 2px solid #333;
            border-radius: 8px;
            background: transparent;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .speed-btn.active {
            border-color: #ffa502;
            background: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }

        .speed-btn:active { transform: scale(0.95); }

        .frame-row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .frame-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1a1a2e;
            color: #aaa;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .frame-btn:active { background: #252540; }

        .progress-wrap {
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffa502, #ff6348);
            width: 0%;
            border-radius: 3px;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* ========== LANDSCAPE OPTIMIZATIONS ========== */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 4px 10px;
            }

            .header h1 {
                font-size: 14px;
            }

            .controls {
                padding: 6px 10px;
                padding-bottom: max(6px, env(safe-area-inset-bottom));
            }

            .mode-label {
                display: none;
            }

            .camera-row {
                margin-bottom: 6px;
            }

            .camera-select {
                padding: 6px 8px;
                font-size: 12px;
            }

            .primary-btn {
                padding: 10px;
                font-size: 14px;
            }

            .control-grid {
                margin-bottom: 6px;
                gap: 6px;
            }

            .ctrl-btn {
                padding: 6px 4px;
                font-size: 11px;
            }

            .ctrl-btn .icon {
                font-size: 16px;
            }

            .speed-row {
                margin-bottom: 6px;
            }

            .speed-btn {
                padding: 6px 2px;
                font-size: 11px;
            }

            .frame-row {
                margin-bottom: 6px;
            }

            .frame-btn {
                padding: 6px;
                font-size: 11px;
            }

            .progress-wrap {
                margin-bottom: 6px;
            }

            .video-scrubber {
                bottom: 40px;
            }

            .scrubber-track {
                height: 32px;
                padding: 0 12px;
            }

            .scrubber-input::-webkit-slider-thumb {
                width: 20px;
                height: 20px;
            }
        }

        /* Even more compact for very short screens */
        @media (orientation: landscape) and (max-height: 380px) {
            .header {
                display: none;
            }

            .frame-row {
                display: none;
            }

            .progress-wrap {
                display: none;
            }
        }

        /* ========== FULLSCREEN MODE ========== */
        .app-container.fullscreen-mode .header,
        .app-container.fullscreen-mode .controls {
            display: none !important;
        }

        .app-container.fullscreen-mode .video-container {
            height: 100vh;
            height: 100dvh;
        }

        .exit-fullscreen-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #555;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            z-index: 50;
            display: none;
        }

        .app-container.fullscreen-mode .exit-fullscreen-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Fullscreen review controls overlay */
        .fullscreen-review-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 60px 16px 16px;
            display: none;
            z-index: 30;
        }

        .app-container.fullscreen-mode.review-active .fullscreen-review-controls {
            display: block;
        }

        .fs-control-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 12px;
        }

        .fs-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .fs-btn:active {
            background: rgba(255,255,255,0.25);
        }

        .fs-btn.play-btn {
            background: #00b894;
            padding: 12px 30px;
        }

        .fs-btn.play-btn.paused {
            background: #fdcb6e;
            color: #000;
        }

        .fs-speed-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .fs-speed-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            color: #888;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .fs-speed-btn.active {
            border-color: #ffa502;
            color: #ffa502;
            background: rgba(255, 165, 2, 0.15);
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>Line Review</h1>
            <div class="header-right">
                <div class="recording-indicator" id="recordingIndicator">Ready</div>
                <button class="fullscreen-btn" id="fullscreenBtn">‚õ∂</button>
            </div>
        </header>

        <div class="video-container">
            <video id="liveVideo" autoplay playsinline muted></video>
            <canvas id="reviewCanvas"></canvas>

            <div class="overlay-info">
                <div class="info-badge recording" id="modeBadge">‚óè LIVE</div>
            </div>

            <div class="buffer-badge" id="bufferBadge">
                Buffer: <span id="bufferCount">0</span>s
            </div>

            <div class="time-badge" id="timeBadge">00:00.0</div>

            <!-- Video scrubber slider -->
            <div class="video-scrubber" id="videoScrubber">
                <div class="scrubber-track">
                    <input type="range" class="scrubber-input" id="scrubberInput" min="0" max="100" value="0">
                </div>
            </div>

            <!-- Exit fullscreen button -->
            <button class="exit-fullscreen-btn" id="exitFullscreenBtn">‚úï Exit</button>

            <!-- Fullscreen review controls -->
            <div class="fullscreen-review-controls" id="fsReviewControls">
                <div class="fs-control-row">
                    <button class="fs-btn" id="fsRewindBtn">‚è™ -15s</button>
                    <button class="fs-btn play-btn" id="fsPlayBtn">‚ñ∂Ô∏è</button>
                    <button class="fs-btn" id="fsForwardBtn">+15s ‚è©</button>
                </div>
                <div class="fs-speed-row">
                    <button class="fs-speed-btn" data-speed="0.1">0.1√ó</button>
                    <button class="fs-speed-btn" data-speed="0.25">0.25√ó</button>
                    <button class="fs-speed-btn" data-speed="0.5">0.5√ó</button>
                    <button class="fs-speed-btn active" data-speed="1">1√ó</button>
                </div>
            </div>

            <div class="status-overlay" id="statusOverlay">
                <div class="spinner"></div>
                <div class="status-text" id="statusText">Initializing camera...</div>
            </div>
        </div>

        <div class="controls">
            <div class="mode-label live" id="modeLabel">‚óè RECORDING</div>

            <div class="camera-row">
                <select class="camera-select" id="cameraSelect">
                    <option value="">Loading cameras...</option>
                </select>
            </div>

            <div class="live-controls" id="liveControls">
                <button class="primary-btn review-btn" id="reviewBtn">
                    ‚è™ Review Last Ball
                </button>
            </div>

            <div class="review-controls" id="reviewControls">
                <div class="control-grid">
                    <button class="ctrl-btn rewind" id="rewindBtn">
                        <span class="icon">‚è™</span>
                        <span>‚àí15s</span>
                    </button>
                    <button class="ctrl-btn play" id="playBtn">
                        <span class="icon">‚ñ∂Ô∏è</span>
                        <span>Play</span>
                    </button>
                    <button class="ctrl-btn forward" id="forwardBtn">
                        <span class="icon">‚è©</span>
                        <span>+15s</span>
                    </button>
                </div>

                <div class="speed-row">
                    <button class="speed-btn" data-speed="0.1">0.1√ó</button>
                    <button class="speed-btn" data-speed="0.25">0.25√ó</button>
                    <button class="speed-btn" data-speed="0.5">0.5√ó</button>
                    <button class="speed-btn active" data-speed="1">1√ó</button>
                </div>

                <div class="frame-row">
                    <button class="frame-btn" id="framePrev">‚óÄ Prev Frame</button>
                    <button class="frame-btn" id="frameNext">Next Frame ‚ñ∂</button>
                </div>

                <div class="progress-wrap">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">00:00.0</span>
                        <span id="totalTime">00:00.0</span>
                    </div>
                </div>

                <button class="primary-btn back-btn" id="backBtn">
                    üìπ Back to Live
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIG & STATE
        // ============================================

        const CONFIG = {
            FPS: 30,
            BUFFER_SECONDS: 90,
            CAPTURE_WIDTH: null,
            CAPTURE_HEIGHT: null
        };

        const state = {
            mode: 'live',
            stream: null,
            captureCanvas: null,
            captureCtx: null,
            frameBuffer: [],
            maxFrames: 2700,
            isCapturing: false,
            captureInterval: null,
            isFullscreen: false,

            // Review state
            reviewIndex: 0,
            isPlaying: false,
            playbackSpeed: 1,
            playbackInterval: null
        };

        const el = {
            appContainer: document.getElementById('appContainer'),
            liveVideo: document.getElementById('liveVideo'),
            reviewCanvas: document.getElementById('reviewCanvas'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            modeBadge: document.getElementById('modeBadge'),
            modeLabel: document.getElementById('modeLabel'),
            bufferBadge: document.getElementById('bufferBadge'),
            bufferCount: document.getElementById('bufferCount'),
            timeBadge: document.getElementById('timeBadge'),
            statusOverlay: document.getElementById('statusOverlay'),
            statusText: document.getElementById('statusText'),
            cameraSelect: document.getElementById('cameraSelect'),
            liveControls: document.getElementById('liveControls'),
            reviewControls: document.getElementById('reviewControls'),
            reviewBtn: document.getElementById('reviewBtn'),
            backBtn: document.getElementById('backBtn'),
            rewindBtn: document.getElementById('rewindBtn'),
            playBtn: document.getElementById('playBtn'),
            forwardBtn: document.getElementById('forwardBtn'),
            framePrev: document.getElementById('framePrev'),
            frameNext: document.getElementById('frameNext'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            exitFullscreenBtn: document.getElementById('exitFullscreenBtn'),
            videoScrubber: document.getElementById('videoScrubber'),
            scrubberInput: document.getElementById('scrubberInput'),
            fsReviewControls: document.getElementById('fsReviewControls'),
            fsRewindBtn: document.getElementById('fsRewindBtn'),
            fsPlayBtn: document.getElementById('fsPlayBtn'),
            fsForwardBtn: document.getElementById('fsForwardBtn')
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            if (!window.isSecureContext) {
                showError('Requires HTTPS', 'Camera access needs a secure connection. Please access via HTTPS.');
                return;
            }

            state.captureCanvas = document.createElement('canvas');
            state.captureCtx = null;

            try {
                showStatus('Requesting camera access...');
                await getCameras();
                await startCamera();
                hideStatus();
                setupListeners();
            } catch (err) {
                console.error('Init error:', err);
                showError('Camera Error', 'Could not access camera. Please allow camera permission and reload.');
            }
        }

        async function getCameras() {
            await navigator.mediaDevices.getUserMedia({ video: true });
            
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(d => d.kind === 'videoinput');

            el.cameraSelect.innerHTML = '';
            cameras.forEach((cam, i) => {
                const opt = document.createElement('option');
                opt.value = cam.deviceId;
                opt.textContent = cam.label || `Camera ${i + 1}`;
                if (cam.label.toLowerCase().includes('back') || cam.label.toLowerCase().includes('rear')) {
                    opt.selected = true;
                }
                el.cameraSelect.appendChild(opt);
            });

            if (cameras.length === 0) {
                throw new Error('No cameras found');
            }
        }

        async function startCamera(deviceId) {
            if (state.stream) {
                state.stream.getTracks().forEach(t => t.stop());
                stopCapturing();
            }

            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    frameRate: { ideal: CONFIG.FPS },
                    facingMode: deviceId ? undefined : 'environment'
                },
                audio: false
            };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            }

            state.stream = await navigator.mediaDevices.getUserMedia(constraints);
            el.liveVideo.srcObject = state.stream;

            await new Promise(resolve => {
                el.liveVideo.onloadedmetadata = () => {
                    el.liveVideo.play();
                    resolve();
                };
            });

            const videoWidth = el.liveVideo.videoWidth;
            const videoHeight = el.liveVideo.videoHeight;
            
            console.log(`Camera resolution: ${videoWidth}x${videoHeight}`);

            const maxDimension = 1280;
            let captureWidth, captureHeight;
            
            if (videoWidth > videoHeight) {
                captureWidth = Math.min(videoWidth, maxDimension);
                captureHeight = Math.round(captureWidth * (videoHeight / videoWidth));
            } else {
                captureHeight = Math.min(videoHeight, maxDimension);
                captureWidth = Math.round(captureHeight * (videoWidth / videoHeight));
            }

            CONFIG.CAPTURE_WIDTH = captureWidth;
            CONFIG.CAPTURE_HEIGHT = captureHeight;

            state.captureCanvas.width = captureWidth;
            state.captureCanvas.height = captureHeight;
            state.captureCtx = state.captureCanvas.getContext('2d', { willReadFrequently: true });

            el.reviewCanvas.width = captureWidth;
            el.reviewCanvas.height = captureHeight;

            const bytesPerFrame = captureWidth * captureHeight * 4;
            const targetMemoryMB = 300;
            const maxFramesByMemory = Math.floor((targetMemoryMB * 1024 * 1024) / bytesPerFrame);
            state.maxFrames = Math.min(CONFIG.FPS * CONFIG.BUFFER_SECONDS, maxFramesByMemory);

            state.frameBuffer = [];
            startCapturing();
        }

        // ============================================
        // FRAME CAPTURE
        // ============================================

        function startCapturing() {
            if (state.isCapturing) return;

            state.isCapturing = true;
            state.frameBuffer = [];

            const intervalMs = 1000 / CONFIG.FPS;

            state.captureInterval = setInterval(() => {
                captureFrame();
            }, intervalMs);

            el.recordingIndicator.classList.add('active');
            el.recordingIndicator.textContent = 'Recording';
        }

        function stopCapturing() {
            if (state.captureInterval) {
                clearInterval(state.captureInterval);
                state.captureInterval = null;
            }
            state.isCapturing = false;
            el.recordingIndicator.classList.remove('active');
            el.recordingIndicator.textContent = 'Paused';
        }

        function captureFrame() {
            if (!state.stream || !el.liveVideo.videoWidth) return;

            state.captureCtx.drawImage(
                el.liveVideo,
                0, 0,
                CONFIG.CAPTURE_WIDTH,
                CONFIG.CAPTURE_HEIGHT
            );

            const imageData = state.captureCtx.getImageData(
                0, 0,
                CONFIG.CAPTURE_WIDTH,
                CONFIG.CAPTURE_HEIGHT
            );

            state.frameBuffer.push(imageData);

            while (state.frameBuffer.length > state.maxFrames) {
                state.frameBuffer.shift();
            }

            updateBufferDisplay();
        }

        function updateBufferDisplay() {
            const frames = state.frameBuffer.length;
            const seconds = (frames / CONFIG.FPS).toFixed(1);
            el.bufferCount.textContent = seconds;
        }

        // ============================================
        // REVIEW MODE
        // ============================================

        function enterReviewMode() {
            if (state.frameBuffer.length < CONFIG.FPS) {
                alert('Not enough footage yet. Wait a few seconds and try again.');
                return;
            }

            stopCapturing();
            state.mode = 'review';
            
            const framesBack = Math.min(CONFIG.FPS * 15, state.frameBuffer.length - 1);
            state.reviewIndex = state.frameBuffer.length - framesBack;
            state.isPlaying = false;
            state.playbackSpeed = 1;

            el.liveVideo.style.display = 'none';
            el.reviewCanvas.style.display = 'block';
            el.liveControls.classList.add('hidden');
            el.reviewControls.classList.add('active');
            el.bufferBadge.style.display = 'none';
            el.videoScrubber.classList.add('visible');
            el.appContainer.classList.add('review-active');

            el.modeBadge.textContent = '‚è∏ REVIEW';
            el.modeBadge.classList.remove('recording');
            el.modeBadge.classList.add('review');

            el.modeLabel.textContent = '‚è∏ REVIEW MODE';
            el.modeLabel.classList.remove('live');
            el.modeLabel.classList.add('review');

            const totalSec = state.frameBuffer.length / CONFIG.FPS;
            el.totalTime.textContent = formatTime(totalSec);

            // Setup scrubber
            el.scrubberInput.max = state.frameBuffer.length - 1;
            el.scrubberInput.value = state.reviewIndex;

            renderCurrentFrame();
            updatePlayButton();
            updateProgressBar();
            updateSpeedButtons();
        }

        function exitReviewMode() {
            stopPlayback();
            state.mode = 'live';

            el.reviewCanvas.style.display = 'none';
            el.liveVideo.style.display = 'block';
            el.reviewControls.classList.remove('active');
            el.liveControls.classList.remove('hidden');
            el.bufferBadge.style.display = 'block';
            el.videoScrubber.classList.remove('visible');
            el.appContainer.classList.remove('review-active');

            el.modeBadge.textContent = '‚óè LIVE';
            el.modeBadge.classList.add('recording');
            el.modeBadge.classList.remove('review');

            el.modeLabel.textContent = '‚óè RECORDING';
            el.modeLabel.classList.add('live');
            el.modeLabel.classList.remove('review');

            startCapturing();
        }

        function renderCurrentFrame() {
            if (state.reviewIndex < 0) state.reviewIndex = 0;
            if (state.reviewIndex >= state.frameBuffer.length) {
                state.reviewIndex = state.frameBuffer.length - 1;
            }

            const frame = state.frameBuffer[state.reviewIndex];
            if (!frame) return;

            const ctx = el.reviewCanvas.getContext('2d');
            ctx.putImageData(frame, 0, 0);

            const currentSec = state.reviewIndex / CONFIG.FPS;
            el.currentTime.textContent = formatTime(currentSec);
            el.timeBadge.textContent = formatTime(currentSec);

            updateProgressBar();
            updateScrubber();
        }

        // ============================================
        // PLAYBACK CONTROLS
        // ============================================

        function togglePlay() {
            if (state.isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (state.reviewIndex >= state.frameBuffer.length - 1) {
                state.reviewIndex = 0;
            }

            state.isPlaying = true;
            updatePlayButton();

            const intervalMs = (1000 / CONFIG.FPS) / state.playbackSpeed;

            state.playbackInterval = setInterval(() => {
                state.reviewIndex++;

                if (state.reviewIndex >= state.frameBuffer.length) {
                    stopPlayback();
                    state.reviewIndex = state.frameBuffer.length - 1;
                } else {
                    renderCurrentFrame();
                }
            }, intervalMs);
        }

        function stopPlayback() {
            state.isPlaying = false;
            if (state.playbackInterval) {
                clearInterval(state.playbackInterval);
                state.playbackInterval = null;
            }
            updatePlayButton();
        }

        function seek(seconds) {
            stopPlayback();
            const frameDelta = Math.round(seconds * CONFIG.FPS);
            state.reviewIndex += frameDelta;
            state.reviewIndex = Math.max(0, Math.min(state.frameBuffer.length - 1, state.reviewIndex));
            renderCurrentFrame();
        }

        function stepFrame(direction) {
            stopPlayback();
            state.reviewIndex += direction;
            state.reviewIndex = Math.max(0, Math.min(state.frameBuffer.length - 1, state.reviewIndex));
            renderCurrentFrame();
        }

        function setSpeed(speed) {
            const wasPlaying = state.isPlaying;
            stopPlayback();
            state.playbackSpeed = speed;
            updateSpeedButtons();
            if (wasPlaying) {
                startPlayback();
            }
        }

        function seekToPosition(e) {
            const rect = el.progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const targetIndex = Math.floor(percent * state.frameBuffer.length);
            
            stopPlayback();
            state.reviewIndex = Math.max(0, Math.min(state.frameBuffer.length - 1, targetIndex));
            renderCurrentFrame();
        }

        function seekToScrubberPosition() {
            stopPlayback();
            state.reviewIndex = parseInt(el.scrubberInput.value);
            renderCurrentFrame();
        }

        // ============================================
        // FULLSCREEN
        // ============================================

        function toggleFullscreen() {
            if (state.isFullscreen) {
                exitFullscreen();
            } else {
                enterFullscreen();
            }
        }

        function enterFullscreen() {
            state.isFullscreen = true;
            el.appContainer.classList.add('fullscreen-mode');
            el.fullscreenBtn.textContent = '‚õ∂';

            // Try native fullscreen
            const elem = el.appContainer;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(() => {});
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            }
        }

        function exitFullscreen() {
            state.isFullscreen = false;
            el.appContainer.classList.remove('fullscreen-mode');
            el.fullscreenBtn.textContent = '‚õ∂';

            if (document.exitFullscreen) {
                document.exitFullscreen().catch(() => {});
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }

        // ============================================
        // UI UPDATES
        // ============================================

        function updatePlayButton() {
            if (state.isPlaying) {
                el.playBtn.innerHTML = '<span class="icon">‚è∏</span><span>Pause</span>';
                el.playBtn.classList.remove('paused');
                el.fsPlayBtn.textContent = '‚è∏';
                el.fsPlayBtn.classList.remove('paused');
            } else {
                el.playBtn.innerHTML = '<span class="icon">‚ñ∂Ô∏è</span><span>Play</span>';
                el.playBtn.classList.add('paused');
                el.fsPlayBtn.textContent = '‚ñ∂Ô∏è';
                el.fsPlayBtn.classList.add('paused');
            }
        }

        function updateProgressBar() {
            const percent = (state.reviewIndex / (state.frameBuffer.length - 1)) * 100;
            el.progressFill.style.width = `${percent}%`;
        }

        function updateScrubber() {
            el.scrubberInput.value = state.reviewIndex;
            const percent = (state.reviewIndex / (state.frameBuffer.length - 1)) * 100;
            el.scrubberInput.style.setProperty('--progress', `${percent}%`);
        }

        function updateSpeedButtons() {
            document.querySelectorAll('.speed-btn, .fs-speed-btn').forEach(btn => {
                const speed = parseFloat(btn.dataset.speed);
                btn.classList.toggle('active', speed === state.playbackSpeed);
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const tenths = Math.floor((seconds % 1) * 10);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${tenths}`;
        }

        function showStatus(text) {
            el.statusText.textContent = text;
            el.statusOverlay.classList.remove('hidden');
        }

        function hideStatus() {
            el.statusOverlay.classList.add('hidden');
        }

        function showError(title, message) {
            el.statusOverlay.innerHTML = `
                <div class="error-box">
                    <h3>${title}</h3>
                    <p>${message}</p>
                </div>
            `;
            el.statusOverlay.classList.remove('hidden');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        function setupListeners() {
            el.cameraSelect.addEventListener('change', async (e) => {
                if (e.target.value) {
                    showStatus('Switching camera...');
                    try {
                        await startCamera(e.target.value);
                        hideStatus();
                    } catch (err) {
                        showError('Camera Error', 'Could not switch camera.');
                    }
                }
            });

            el.reviewBtn.addEventListener('click', enterReviewMode);
            el.backBtn.addEventListener('click', exitReviewMode);

            el.playBtn.addEventListener('click', togglePlay);
            el.rewindBtn.addEventListener('click', () => seek(-15));
            el.forwardBtn.addEventListener('click', () => seek(15));

            el.framePrev.addEventListener('click', () => stepFrame(-1));
            el.frameNext.addEventListener('click', () => stepFrame(1));

            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setSpeed(parseFloat(btn.dataset.speed));
                });
            });

            el.progressBar.addEventListener('click', seekToPosition);

            // Fullscreen
            el.fullscreenBtn.addEventListener('click', toggleFullscreen);
            el.exitFullscreenBtn.addEventListener('click', exitFullscreen);

            // Scrubber
            el.scrubberInput.addEventListener('input', seekToScrubberPosition);

            // Fullscreen review controls
            el.fsPlayBtn.addEventListener('click', togglePlay);
            el.fsRewindBtn.addEventListener('click', () => seek(-15));
            el.fsForwardBtn.addEventListener('click', () => seek(15));

            document.querySelectorAll('.fs-speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setSpeed(parseFloat(btn.dataset.speed));
                });
            });

            // Handle native fullscreen exit
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement && state.isFullscreen) {
                    exitFullscreen();
                }
            });

            document.addEventListener('webkitfullscreenchange', () => {
                if (!document.webkitFullscreenElement && state.isFullscreen) {
                    exitFullscreen();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (state.mode !== 'review') return;

                switch (e.key) {
                    case ' ':
                        e.preventDefault();
                        togglePlay();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        seek(-5);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        seek(5);
                        break;
                    case ',':
                        stepFrame(-1);
                        break;
                    case '.':
                        stepFrame(1);
                        break;
                    case 'f':
                        toggleFullscreen();
                        break;
                    case 'Escape':
                        if (state.isFullscreen) exitFullscreen();
                        break;
                }
            });
        }

        // Start the app
        init();
    </script>
</body>
</html>
