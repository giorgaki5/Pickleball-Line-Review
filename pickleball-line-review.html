<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pickleball Line Review</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1::before {
            content: "üèì";
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #888;
        }

        .recording-indicator.active {
            color: #ff4757;
        }

        .recording-indicator.active::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #ff4757;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Video Container */
        .video-container {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #liveVideo, #reviewVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #reviewVideo {
            display: none;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        /* Line guide overlay */
        .line-guide {
            position: absolute;
            bottom: 20%;
            left: 10%;
            right: 10%;
            height: 4px;
            background: rgba(0, 255, 136, 0.3);
            border: 1px dashed rgba(0, 255, 136, 0.6);
            display: none;
        }

        .line-guide.visible {
            display: block;
        }

        /* Playback info overlay */
        .playback-info {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .playback-info.visible {
            display: block;
        }

        .speed-badge {
            display: inline-block;
            background: #ffa502;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 8px;
        }

        .speed-badge.slow {
            background: #ff6b6b;
            color: white;
        }

        /* Time display */
        .time-display {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 16px;
        }

        /* Controls */
        .controls {
            background: linear-gradient(180deg, #16213e 0%, #0f0f1a 100%);
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        /* Mode indicator */
        .mode-indicator {
            text-align: center;
            margin-bottom: 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }

        .mode-indicator.recording {
            color: #00ff88;
        }

        .mode-indicator.reviewing {
            color: #ffa502;
        }

        /* Main action button */
        .main-action {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .main-action.review-btn {
            background: linear-gradient(135deg, #ffa502 0%, #ff6b35 100%);
            color: white;
        }

        .main-action.back-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00b894 100%);
            color: #000;
        }

        .main-action:active {
            transform: scale(0.98);
        }

        /* Playback controls */
        .playback-controls {
            display: none;
            gap: 8px;
        }

        .playback-controls.visible {
            display: flex;
        }

        .control-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .control-btn {
            flex: 1;
            padding: 14px 8px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn .icon {
            font-size: 20px;
        }

        .rewind-btn {
            background: #2d3436;
            color: white;
        }

        .play-pause-btn {
            background: #00b894;
            color: white;
        }

        .play-pause-btn.paused {
            background: #fdcb6e;
            color: #000;
        }

        .forward-btn {
            background: #2d3436;
            color: white;
        }

        /* Speed controls */
        .speed-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .speed-btn {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #333;
            border-radius: 10px;
            background: transparent;
            color: #888;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-btn.active {
            border-color: #ffa502;
            background: rgba(255, 165, 2, 0.1);
            color: #ffa502;
        }

        .speed-btn:active {
            transform: scale(0.95);
        }

        /* Frame step controls */
        .frame-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .frame-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1a1a2e;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
        }

        .frame-btn:active {
            background: #2a2a3e;
        }

        /* Progress bar */
        .progress-container {
            margin-top: 12px;
            padding: 8px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffa502, #ff6b35);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Settings toggle */
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px solid #333;
            margin-top: 8px;
        }

        .settings-label {
            font-size: 13px;
            color: #888;
        }

        .toggle {
            width: 44px;
            height: 24px;
            background: #333;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: #00b894;
        }

        .toggle::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle.active::after {
            transform: translateX(20px);
        }

        /* Camera select */
        .camera-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: white;
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* Status messages */
        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 100;
        }

        .status-message.hidden {
            display: none;
        }

        .status-message .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #ffa502;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state */
        .error-message {
            background: rgba(255, 71, 87, 0.9);
            padding: 16px;
            border-radius: 8px;
            margin: 16px;
            text-align: center;
        }

        /* Buffer indicator */
        .buffer-indicator {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            color: #888;
        }

        .buffer-indicator span {
            color: #00ff88;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Line Review</h1>
            <div class="recording-indicator" id="recordingIndicator">
                Ready
            </div>
        </header>

        <div class="video-container">
            <video id="liveVideo" autoplay playsinline muted></video>
            <video id="reviewVideo" playsinline></video>
            
            <div class="video-overlay">
                <div class="line-guide" id="lineGuide"></div>
            </div>

            <div class="playback-info" id="playbackInfo">
                <span id="playbackStatus">Paused</span>
                <span class="speed-badge" id="speedBadge">1x</span>
            </div>

            <div class="time-display" id="timeDisplay">00:00</div>
            
            <div class="buffer-indicator" id="bufferIndicator">
                Buffer: <span id="bufferTime">0s</span>
            </div>

            <div class="status-message hidden" id="statusMessage">
                <div class="spinner"></div>
                <div>Initializing camera...</div>
            </div>
        </div>

        <div class="controls">
            <div class="mode-indicator recording" id="modeIndicator">‚óè Recording</div>

            <!-- Camera selection -->
            <select class="camera-select" id="cameraSelect">
                <option value="">Select Camera...</option>
            </select>

            <!-- Live mode controls -->
            <div id="liveControls">
                <button class="main-action review-btn" id="reviewBtn">
                    <span>‚è™</span> Review Last Ball
                </button>
            </div>

            <!-- Review mode controls -->
            <div class="playback-controls" id="reviewControls">
                <div style="width: 100%;">
                    <div class="control-row">
                        <button class="control-btn rewind-btn" id="rewind15Btn">
                            <span class="icon">‚è™</span>
                            <span>-15s</span>
                        </button>
                        <button class="control-btn play-pause-btn" id="playPauseBtn">
                            <span class="icon">‚è∏Ô∏è</span>
                            <span>Pause</span>
                        </button>
                        <button class="control-btn forward-btn" id="forward15Btn">
                            <span class="icon">‚è©</span>
                            <span>+15s</span>
                        </button>
                    </div>

                    <div class="speed-controls">
                        <button class="speed-btn" data-speed="0.1">0.1x</button>
                        <button class="speed-btn" data-speed="0.25">0.25x</button>
                        <button class="speed-btn" data-speed="0.5">0.5x</button>
                        <button class="speed-btn active" data-speed="1">1x</button>
                    </div>

                    <div class="frame-controls">
                        <button class="frame-btn" id="framePrevBtn">‚óÄ Frame</button>
                        <button class="frame-btn" id="frameNextBtn">Frame ‚ñ∂</button>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>

                    <button class="main-action back-btn" id="backToLiveBtn">
                        <span>üìπ</span> Back to Live
                    </button>

                    <div class="settings-row">
                        <span class="settings-label">Show line guide</span>
                        <div class="toggle" id="lineGuideToggle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        const state = {
            mode: 'live', // 'live' or 'review'
            isRecording: false,
            isPaused: false,
            playbackSpeed: 1,
            mediaRecorder: null,
            recordedChunks: [],
            recordedBlob: null,
            stream: null,
            bufferDuration: 120, // Keep 2 minutes of buffer
            showLineGuide: false
        };

        // DOM Elements
        const elements = {
            liveVideo: document.getElementById('liveVideo'),
            reviewVideo: document.getElementById('reviewVideo'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            modeIndicator: document.getElementById('modeIndicator'),
            reviewBtn: document.getElementById('reviewBtn'),
            liveControls: document.getElementById('liveControls'),
            reviewControls: document.getElementById('reviewControls'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            rewind15Btn: document.getElementById('rewind15Btn'),
            forward15Btn: document.getElementById('forward15Btn'),
            backToLiveBtn: document.getElementById('backToLiveBtn'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            timeDisplay: document.getElementById('timeDisplay'),
            playbackInfo: document.getElementById('playbackInfo'),
            playbackStatus: document.getElementById('playbackStatus'),
            speedBadge: document.getElementById('speedBadge'),
            statusMessage: document.getElementById('statusMessage'),
            cameraSelect: document.getElementById('cameraSelect'),
            bufferIndicator: document.getElementById('bufferIndicator'),
            bufferTime: document.getElementById('bufferTime'),
            lineGuide: document.getElementById('lineGuide'),
            lineGuideToggle: document.getElementById('lineGuideToggle'),
            framePrevBtn: document.getElementById('framePrevBtn'),
            frameNextBtn: document.getElementById('frameNextBtn')
        };

        // Initialize app
        async function init() {
            showStatus('Initializing camera...');
            
            try {
                await enumerateCameras();
                await startCamera();
                hideStatus();
            } catch (error) {
                console.error('Init error:', error);
                showError('Camera access denied. Please allow camera access and reload.');
            }

            setupEventListeners();
        }

        // Enumerate available cameras
        async function enumerateCameras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            
            elements.cameraSelect.innerHTML = '<option value="">Select Camera...</option>';
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.textContent = device.label || `Camera ${index + 1}`;
                elements.cameraSelect.appendChild(option);
            });

            // Auto-select if only one camera
            if (videoDevices.length === 1) {
                elements.cameraSelect.value = videoDevices[0].deviceId;
            }
        }

        // Start camera stream
        async function startCamera(deviceId = null) {
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    frameRate: { ideal: 60, min: 30 },
                    facingMode: deviceId ? undefined : 'environment'
                },
                audio: false
            };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            }

            state.stream = await navigator.mediaDevices.getUserMedia(constraints);
            elements.liveVideo.srcObject = state.stream;
            
            startRecording();
        }

        // Start continuous recording
        function startRecording() {
            if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                state.mediaRecorder.stop();
            }

            state.recordedChunks = [];
            
            const options = { 
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 8000000 // 8 Mbps for quality
            };
            
            // Fallback for Safari
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm';
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/mp4';
                }
            }

            state.mediaRecorder = new MediaRecorder(state.stream, options);
            
            state.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    state.recordedChunks.push(event.data);
                    
                    // Update buffer indicator
                    updateBufferIndicator();
                    
                    // Trim old chunks to maintain buffer duration
                    trimBuffer();
                }
            };

            state.mediaRecorder.start(1000); // Capture every second
            state.isRecording = true;
            updateRecordingIndicator();
        }

        // Trim buffer to keep only recent footage
        function trimBuffer() {
            // Estimate ~1MB per second at our bitrate
            const maxChunks = state.bufferDuration;
            while (state.recordedChunks.length > maxChunks) {
                state.recordedChunks.shift();
            }
        }

        // Update buffer indicator
        function updateBufferIndicator() {
            const seconds = state.recordedChunks.length;
            elements.bufferTime.textContent = `${seconds}s`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Camera selection
            elements.cameraSelect.addEventListener('change', async (e) => {
                if (e.target.value) {
                    showStatus('Switching camera...');
                    await startCamera(e.target.value);
                    hideStatus();
                }
            });

            // Review button
            elements.reviewBtn.addEventListener('click', enterReviewMode);

            // Back to live button
            elements.backToLiveBtn.addEventListener('click', exitReviewMode);

            // Play/Pause
            elements.playPauseBtn.addEventListener('click', togglePlayPause);

            // Rewind/Forward
            elements.rewind15Btn.addEventListener('click', () => seek(-15));
            elements.forward15Btn.addEventListener('click', () => seek(15));

            // Frame step buttons
            elements.framePrevBtn.addEventListener('click', () => frameStep(-1));
            elements.frameNextBtn.addEventListener('click', () => frameStep(1));

            // Speed controls
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    setPlaybackSpeed(parseFloat(e.target.dataset.speed));
                });
            });

            // Progress bar
            elements.progressBar.addEventListener('click', (e) => {
                const rect = elements.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                elements.reviewVideo.currentTime = percent * elements.reviewVideo.duration;
            });

            // Video time update
            elements.reviewVideo.addEventListener('timeupdate', updateProgress);

            // Line guide toggle
            elements.lineGuideToggle.addEventListener('click', toggleLineGuide);
        }

        // Enter review mode
        async function enterReviewMode() {
            if (state.recordedChunks.length === 0) {
                alert('No footage recorded yet. Wait a few seconds and try again.');
                return;
            }

            showStatus('Preparing review...');

            // Create blob from recorded chunks
            state.recordedBlob = new Blob(state.recordedChunks, { 
                type: state.mediaRecorder.mimeType 
            });
            
            const url = URL.createObjectURL(state.recordedBlob);
            elements.reviewVideo.src = url;
            
            elements.reviewVideo.onloadedmetadata = () => {
                // Start at 15 seconds from end, or at start if less than 15s
                const startTime = Math.max(0, elements.reviewVideo.duration - 15);
                elements.reviewVideo.currentTime = startTime;
                elements.reviewVideo.pause();
                
                state.mode = 'review';
                state.isPaused = true;
                
                // Update UI
                elements.liveVideo.style.display = 'none';
                elements.reviewVideo.style.display = 'block';
                elements.liveControls.style.display = 'none';
                elements.reviewControls.classList.add('visible');
                elements.playbackInfo.classList.add('visible');
                elements.bufferIndicator.style.display = 'none';
                
                updateModeIndicator();
                updatePlayPauseButton();
                hideStatus();
            };
        }

        // Exit review mode
        function exitReviewMode() {
            state.mode = 'live';
            
            // Clean up
            elements.reviewVideo.pause();
            URL.revokeObjectURL(elements.reviewVideo.src);
            
            // Update UI
            elements.liveVideo.style.display = 'block';
            elements.reviewVideo.style.display = 'none';
            elements.liveControls.style.display = 'block';
            elements.reviewControls.classList.remove('visible');
            elements.playbackInfo.classList.remove('visible');
            elements.bufferIndicator.style.display = 'block';
            
            // Reset playback speed
            setPlaybackSpeed(1);
            
            updateModeIndicator();
        }

        // Toggle play/pause
        function togglePlayPause() {
            if (state.isPaused) {
                elements.reviewVideo.play();
                state.isPaused = false;
            } else {
                elements.reviewVideo.pause();
                state.isPaused = true;
            }
            updatePlayPauseButton();
        }

        // Seek forward/backward
        function seek(seconds) {
            const newTime = elements.reviewVideo.currentTime + seconds;
            elements.reviewVideo.currentTime = Math.max(0, Math.min(newTime, elements.reviewVideo.duration));
        }

        // Frame step (approximate - 1/30th of a second per frame)
        function frameStep(frames) {
            const frameTime = 1 / 30; // Assuming 30fps
            elements.reviewVideo.currentTime += frames * frameTime;
            if (!state.isPaused) {
                elements.reviewVideo.pause();
                state.isPaused = true;
                updatePlayPauseButton();
            }
        }

        // Set playback speed
        function setPlaybackSpeed(speed) {
            state.playbackSpeed = speed;
            elements.reviewVideo.playbackRate = speed;
            
            // Update UI
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
            });
            
            elements.speedBadge.textContent = `${speed}x`;
            elements.speedBadge.classList.toggle('slow', speed < 1);
        }

        // Update progress bar
        function updateProgress() {
            const percent = (elements.reviewVideo.currentTime / elements.reviewVideo.duration) * 100;
            elements.progressFill.style.width = `${percent}%`;
            
            // Update time display
            const current = formatTime(elements.reviewVideo.currentTime);
            const total = formatTime(elements.reviewVideo.duration);
            elements.timeDisplay.textContent = `${current} / ${total}`;
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update recording indicator
        function updateRecordingIndicator() {
            if (state.isRecording) {
                elements.recordingIndicator.classList.add('active');
                elements.recordingIndicator.textContent = 'Recording';
            } else {
                elements.recordingIndicator.classList.remove('active');
                elements.recordingIndicator.textContent = 'Ready';
            }
        }

        // Update mode indicator
        function updateModeIndicator() {
            if (state.mode === 'live') {
                elements.modeIndicator.textContent = '‚óè Recording';
                elements.modeIndicator.classList.add('recording');
                elements.modeIndicator.classList.remove('reviewing');
            } else {
                elements.modeIndicator.textContent = '‚è∏ Review Mode';
                elements.modeIndicator.classList.remove('recording');
                elements.modeIndicator.classList.add('reviewing');
            }
        }

        // Update play/pause button
        function updatePlayPauseButton() {
            if (state.isPaused) {
                elements.playPauseBtn.innerHTML = '<span class="icon">‚ñ∂Ô∏è</span><span>Play</span>';
                elements.playPauseBtn.classList.add('paused');
                elements.playbackStatus.textContent = 'Paused';
            } else {
                elements.playPauseBtn.innerHTML = '<span class="icon">‚è∏Ô∏è</span><span>Pause</span>';
                elements.playPauseBtn.classList.remove('paused');
                elements.playbackStatus.textContent = 'Playing';
            }
        }

        // Toggle line guide
        function toggleLineGuide() {
            state.showLineGuide = !state.showLineGuide;
            elements.lineGuideToggle.classList.toggle('active', state.showLineGuide);
            elements.lineGuide.classList.toggle('visible', state.showLineGuide);
        }

        // Show status message
        function showStatus(message) {
            elements.statusMessage.querySelector('div:last-child').textContent = message;
            elements.statusMessage.classList.remove('hidden');
        }

        // Hide status message
        function hideStatus() {
            elements.statusMessage.classList.add('hidden');
        }

        // Show error
        function showError(message) {
            elements.statusMessage.innerHTML = `<div class="error-message">${message}</div>`;
            elements.statusMessage.classList.remove('hidden');
        }

        // Keyboard shortcuts (for testing on desktop)
        document.addEventListener('keydown', (e) => {
            if (state.mode !== 'review') return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'ArrowLeft':
                    seek(-5);
                    break;
                case 'ArrowRight':
                    seek(5);
                    break;
                case ',':
                    frameStep(-1);
                    break;
                case '.':
                    frameStep(1);
                    break;
            }
        });

        // Start the app
        init();
    </script>
</body>
</html>
